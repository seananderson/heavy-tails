\documentclass[12pt]{article}
\usepackage{geometry}
\geometry{verbose, letterpaper, tmargin = 2.54cm, bmargin = 2.54cm,
  lmargin = 2.54cm, rmargin = 2.54cm}
\geometry{letterpaper}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{setspace}
\usepackage{booktabs}
\usepackage{ragged2e}
\usepackage{verbatim}
\usepackage[sectionbib]{chapterbib}
\usepackage{amsmath}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{array}
\usepackage{tabu} % for spacing between rows in longtable
\usepackage{titlesec}
\usepackage{url}
\usepackage{mathtools}
\usepackage{cite}
\usepackage{citesupernumber}

\usepackage{lineno}
\usepackage{xcolor}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\modulolinenumbers[2]

% Linux Libertine:
\usepackage{textcomp}
\usepackage[sb]{libertine}
\usepackage[varqu,varl]{inconsolata}% sans serif typewriter
\usepackage[libertine,bigdelims,vvarbb]{newtxmath} % bb from STIX
\usepackage[cal=boondoxo]{mathalfa} % mathcal
\useosf % osf for text, not math
\usepackage[supstfm=libertinesups,%
  supscaled=1.2,%
  raised=-.13em]{superiors}

\mathchardef\mhyphen="2D % math hyphen

\textheight 22.0cm

\usepackage[round,sectionbib]{natbib}
\bibpunct{(}{)}{;}{a}{}{;}

\setlength\parskip{0.10in}
\setlength\parindent{0in}

% Fix line numbering and align environment
% http://phaseportrait.blogspot.ca/2007/08/lineno-and-amsmath-compatibility.html
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
     {\linenomath\csname old#1\endcsname}%
     {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
  \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}

% remove numbers in front of sections:
\makeatletter
\renewcommand\@seccntformat[1]{}
\makeatother


\title{Supporting Information:\\Evidence for black-swan events in animal
  populations}

\author{
Sean C. Anderson$^{1,2}$ \and
Trevor A. Branch$^2$ \and
Andrew B. Cooper$^3$ \and
Nicholas K. Dulvy$^1$
}
\date{}

\begin{document}


\input{../analysis/values} % R output

\maketitle

\textsuperscript{1}Earth to Ocean Research Group, Department of Biological
Sciences, Simon Fraser University, Burnaby BC, V5A 1S6, Canada

\textsuperscript{2}School of Resource and Environmental Management, Simon
Fraser University, Burnaby, BC, V5A 1S6, Canada

\textsuperscript{3}School of Aquatic and Fishery Sciences, University of
Washington, Box 355020, Seattle, WA 98195, USA

\linenumbers
\onehalfspacing


%\begin{centering}
%\LARGE
%Supporting Information\\[1.0em]
%\end{centering}


\section{Data selection}

We applied the following data selection and quality-control rules to the
Global Population Dynamics Database (GPDD):

\begin{enumerate}

\item To remove populations with unreliable population indices that could be
  strongly confounded with economics and sampling effort, we removed all
  populations with a sampling protocol listed as \texttt{harvest} as well
  populations with the words \texttt{harvest} or \texttt{fur} in the cited
  reference title.

\item We removed all populations with uneven sampling intervals, i.e.\ we
  removed populations that did not have a constant difference between the
  ``decimal year begin'' and ``decimal year end'' columns.

\item We removed all populations rated as $< 2$ in the GPDD quality assessment
  (on a scale of $1$ to $5$, with $1$ being the lowest quality data)
  \citep[following][]{sibly2005, ziebarth2010}.

\item Populations with negative abundance values were removed. Of the
  populations that remained at the end of our other filtering rules, the
  remaining populations with negative abundances listed were all from time
  series that had been standardized by subtracting the mean and dividing by the
  standard deviation. We verified this by locating the original papers the
  datasets were extracted from: \citet{colebrook1978} for zooplankton and
  \citet{lindstrom1995} for grouse. Since the papers did not include the
  original mean time-series values we could not back transform these data
  points.

\item We filled in all missing time steps with \texttt{NA} values and imputed
  single missing values with the geometric mean of the previous and following
  values. We chose a geometric mean to be linear on the log scale that the
  Gompertz and Ricker-logistic models were fit on.

\item We filled in single recorded values of zero with the lowest non-zero
  value in the time series \citep[following][]{brook2006a}. This assumes that
  single values of zero result from abundance being low enough that censusing
  overlooked individuals that were actually present. We turned multiple zero
  values in a row into \texttt{NA} values. This implies that multiple zero
  values were either censusing errors or caused by emigration. Regardless, our
  population models were fit on a multiplicative (log) scale and so could not
  account for zero abundance. To avoid distorting the original data too
  strongly, we removed populations in which we filled in more than four zeros.

\item We removed all populations without at least four unique values
  \citep[following][]{brook2006a}.

\item We removed all populations with four or more identical values in a row
  since these suggest either recording error or extrapolation between two
  observations.

\item We then wrote an algorithm to find the longest unbroken window of
  abundance (no \texttt{NA}s) with at least $20$ time steps in each population
  time series. If there were any populations with multiple windows of identical
  length, we took the most recent window. This is a longer window than used in
  some previous analyses \citep[e.g.][]{brook2006a}, but since our model
  attempts to capture the shape of the distribution tails, our model requires
  more data.

\item We removed GPDD Main IDs \texttt{20531} and \texttt{10139}, which we
  noticed were duplicates of \texttt{20579} (a heron population).
  \texttt{20579} contained additional years of data not present in
  \texttt{10139}. We removed a limited number of populations from class
  Angiospermopsida and Bacillariophyceae to focus the taxonomy in our analysis
  on animals. We also removed any populations with an \texttt{Unknown}
  taxonomic class.

\item Finally, we removed populations with the following GPDD Main IDs, which
  we discovered were data entry errors when verifying the populations with
  suspected black swans: \texttt{1207} because the 1957 data point was entered
  as 2 but should have been 27 \citep{kendeigh1982}, \texttt{6531} because the
  1978 data point was entered as 7 but should have been 47 \citep{minot1986},
  and \texttt{6566} because some of the data did not match the graph
  \citep{heessen1996}.

\end{enumerate}

\noindent
%We provide a supplemental figure of all the time series included in our
%analysis and indicate which values were interpolated (non-zero interpolations)
\percImputedPops\% of populations had at least one point interpolated but
only \percImputedPoints\% of the total observations were interpolated.
We note that interpolation is highly unlikely to lead to
black-swan detections, since black swans involve extreme increases or
decreases.

\section{Implementation of the skewed Student-t distribution in Stan}

The probability density for the skewed Student t distribution described in the
Methods section translates to the log probability:

\[
\mathrm{Skewed\,Student\mhyphen t}(x) =
\begin{dcases}
  \log (2 \gamma) - \log(\gamma^2 + 1) +
  \log \mathrm{Student\mhyphen t}(x \cdot \gamma, \nu, \mu \cdot \gamma, \sigma),& \text{for } x < 0\\
  \log (2 \gamma) - \log(\gamma^2 + 1) +
  \log \mathrm{Student\mhyphen t}(x / \gamma, \nu, \mu / \gamma, \sigma),& \text{for } x \ge 0
\end{dcases}
\]

Since Stan only needs the probability density up to an additive
constant \citep{stan-manual2014}, we
can replace $\log(2 \gamma)$ in the above for $\log(\gamma)$. The final log
probability density for the skewed Student's t distribution implemented in
Stan\footnote{Credit to Stan developer Bob Carpenter:
\url{https://groups.google.com/d/msg/stan-users/jeZQnQRUsDs/BeqhicWm1GEJ}}
looks like the following:

\begin{verbatim}
real skew_student_t_log(real y, real nu, real mu, real sigma, real skew) {
  real lp;
  lp <- log(skew) - log1p(square(skew));
  if (y < mu)
    return lp + student_t_log(y * skew, nu, mu * skew, sigma);
  else
    return lp + student_t_log(y / skew, nu, mu / skew, sigma);
}
\end{verbatim}

\section{Heavy-tailed Gompertz model simulations}

The following pseudo R code illustrates the procedure to generate process
noise with effective $\nu$ values within a CV of 0.2 of the specified value
(the actual code is available at
\url{https://github.com/seananderson/heavy-tails}):

\begin{footnotesize}
\begin{verbatim}
get_effective_nu_seeds <- function(nu_true = 5, cv = 0.2, N = 50, seed_N = 20) {
  # nu_true: The true nu value
  # cv:      The permitted effective nu coefficient of variation
  # N:       The length of time series
  # seed_N:  The number of seed values to generate
  seeds <- numeric(length = seed_N)
  seed_value <- 0
  for (i in seq_len(seed_N)) {
    nu_close <- FALSE
    while (!nu_close) {
      seed_value <- seed_value + 1
      set.seed(i)
      y <- rt(N, df = nu_true)
      sm <- rstan::stan(... # fit the Stan model here
      med_nu_hat <- median(rstan::extract(sm, pars = "nu")[[1]])
      if (med_nu_hat > (nu_true - cv) & med_nu_hat < (nu_true + cv)) {
        nu_close <- TRUE
        seeds[i] <- seed_value
      }
    }
  }
  seeds
}
nu_3_seeds_N50 <- get_effective_nu_seeds(nu_true = 3)
nu_5_seeds_N50 <- get_effective_nu_seeds(nu_true = 5)
\end{verbatim}
\end{footnotesize}

%\clearpage
\section{Additional acknowledgements}

Many of the silhouette images used in Figs 2, and 3 were obtained from
\texttt{phylopic.org} under Creative Commons licenses. We vectorized the
salmon in Fig.~2. The bird in these figures was obtained
from \texttt{phylopic.org} under a Creative Commons Attribution 3.0 Unported
license with credit to Jean-RaphaÃ«l Guillaumin {[}photography{]} and T.
Michael Keesey {[}vectorization{]}). The silhouettes in
Fig.~3 were obtained from the following sources (metadata
obtained with the help of the rphylopic R package,
\url{https://github.com/sckott/rphylopic}):

\LTcapwidth=\textwidth
\singlespacing
\begin{footnotesize}
\begin{longtable}{>{\RaggedRight}m{3.2cm}>{\RaggedRight}p{6.5cm}>{\RaggedRight}p{5.0cm}}
%\caption{Phylopic credits}\\
\toprule
\input{../analysis/phylopic.tex}
\label{tab:phylopic}
\end{longtable}
\end{footnotesize}
\onehalfspacing


\bibliographystyle{apalike}
\bibliography{/Users/seananderson/Dropbox/tex/jshort,supp}
%
% ------------------------------
% Supplemental Tables
% ------------------------------

%\clearpage
%\renewcommand{\thetable}{S\arabic{table}}
%\setcounter{table}{0}

% ------------------------------
% Supplemental Figures
% ------------------------------

%\renewcommand{\thefigure}{S\arabic{figure}}
%\setcounter{figure}{0}

% \begin{centering}
% \clearpage
% \includegraphics[width=\textwidth]{../analysis/all-clean-ts-mammals.pdf}\\
% Figure~\ref{fig:all-ts} (mammals) continued on next page \ldots
%
% \clearpage
% \includegraphics[width=\textwidth]{../analysis/all-clean-ts-birds.pdf}\\
% Figure~\ref{fig:all-ts} (birds) continued on next page \ldots
%
% \clearpage
% \includegraphics[width=\textwidth]{../analysis/all-clean-ts-insects.pdf}\\
% Figure~\ref{fig:all-ts} (insects) continued on next page \ldots
%
% \end{centering}

% \begin{figure}[htbp]
% \begin{center}
% \includegraphics[width=\textwidth]{../analysis/all-clean-ts-fishes-others.pdf}
%
% \caption[All filtered time series used in our analysis.]{(fishes, crustaceans,
%   gastropods, sharks). All filtered time series used in our analysis. The
%   abundances are shown on a log10 vertical axis. Throughout this figure, red
%   dots indicate values that were interpolated and blue dots indicate values
%   that were recorded as zero but were set to the next lowest observed
%   abundance. Numbers before each species name are the GPDD Main ID numbers.}
%
% \label{fig:all-ts}
% \end{center}
% \end{figure}

%\clearpage

\clearpage

\noindent
Example Stan code for a heavy-tailed Gompertz model with AR1 correlated
residuals and a specified level of observation error. The specific code for
the various models in our analysis is available at
\url{https://github.com/seananderson/heavy-tails}.

%\begin{spacing}{1.15}
\begin{footnotesize}
\begin{verbatim}
data {
  int<lower=3> N;              // number of observations
  vector[N] y;                 // vector to hold ln abundance observations
  real<lower=0> nu_rate;       // rate parameter for nu exponential prior
}
parameters {
  real lambda;                 // Gompertz growth rate parameter
  real<lower=-1, upper=2> b;   // Gompertz density dependence parameter
  real<lower=0> sigma_proc;    // process noise scale parameter
  real<lower=2> nu;            // t-distribution degrees of freedom
  real<lower=-1, upper=1> phi; // AR1 parameter
  vector[N] U;                 // unobserved states
  real<lower=0> sigma_obs;     // specified observation error SD
}
transformed parameters {
  vector[N] epsilon;           // error terms
  epsilon[1] <- 0;
  for (i in 2:N) {
    epsilon[i] <- U[i] - (lambda + b * U[i - 1])
                       - (phi * epsilon[i - 1]);
  }
}
model {
  // priors:
  nu ~ exponential(nu_rate);
  lambda ~ normal(0, 10);
  sigma_proc ~ cauchy(0, 2.5);
  phi ~ normal(0, 1);
  // data model:
  for (i in 2:N) {
    U[i] ~ student_t(nu,
                     lambda + b * U[i - 1]
                     + phi * epsilon[i - 1],
                     sigma_proc);
  }
  y ~ normal(U, sigma_obs);
}
\end{verbatim}
\end{footnotesize}

\clearpage
\noindent
Stan code for the multilevel beta regression:
\begin{footnotesize}
\verbatiminput{../analysis/betareg4.stan}
\end{footnotesize}

\clearpage

\noindent
The GPDD IDs used in our analysis.

\begin{footnotesize}
%\renewcommand{\baselinestretch}{1.11}
\noindent
{\tt
\input{../analysis/mainids}
}
%\renewcommand{\baselinestretch}{\textstretch}
\end{footnotesize}
\normalsize
%\end{spacing}

\end{document}
